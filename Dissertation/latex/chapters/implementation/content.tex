%TC:group tabular 1 1
%TC:group table 1 1

\chapter{Implementation}

\paragraph{} This chapter shall explain how turtles are defined and cover the remaining features of the initial prototype. The format and results of the formative evaluation using this initial prototype shall be summarised. Next, the design decisions and changes that were made to Excello during the participatory design process will be discussed. Then, the technical details of Excello and the MIDI to Excello converter will be explained. Concluding with an overview of the project repository.

\section{Initial Prototype}

\paragraph{} Notes and turtles can be defined in any cell. Turtles' interpretation of cells is shown in table \ref{tab:cells}. When the Excello add-in is opened, a window opens on the right side of Excel. Play and stop buttons can be used to launch all the turtles defined in the spreadsheet and initiate playback. Playback is a realistic piano sound.

\begin{table}[htb]
\centering
% \caption{Grammar Rules for the turtle movement instructions. $z \in \Z$}
\vspace{1pt}
\begin{tabular}{|l|l|} \hline
\textbf{Interpretation}&\textbf{Format}\\ \hline
Note& Name (A-G), optional accidental and octave number e.g. \texttt{F\#4}\\ \hline
Sustain& \texttt{s}\\ \hline
Multiple notes& Notes, rests or sustains separated by a comma. Rests \\
subdivided in time& must be a space or an empty string e.g. \texttt{E4,,C4,s}\\ \hline
Rest& Any cell not interpreted as a note, sustain or multi-note. \\ \hline
\end{tabular}
\label{tab:cells}
\caption{Interpretation of cells.}
\end{table}

\subsection{Turtles}

\paragraph{} Turtles are defined by \\
\texttt{!turtle(<Starting Cell>, <Movement>, <Speed>, <Number of Loops>)}

\subsubsection{Activation}

\paragraph{} ``\texttt{!}" indicates the turtle will be activated when the play button is pressed. Just as digital audio workstations allow track muting and soloing, this can be used to modify which turtles play without losing their definitions.

\subsubsection{Starting Cell}

\paragraph{} The turtle's starting cell, which is also played, is a cell reference. As with Excel formulae, this is a concatenation of letters for the column and numbers for the row.

\paragraph{} As each turtle only plays one note at a time, multiple turtles must be defined to play polyphonic music such as chords. It was believed that users would define turtles following identical paths but in adjacent rows or columns. Multiple turtles following identical paths but starting from adjacent cells are defined using the existing Excel range notation for the starting cells. ``\texttt{A2:A5}" would define four turtles in the cells A2,A3,A4,A5. This prevents writing multiple turtle definitions differing in only the start cell row.

\subsubsection{Movement}

\paragraph{} Turtles start facing north. The language for programming turtle movement is discussed in the preparation chapter. Using brackets to repeat movements was not implemented by the start of the participatory design process.

\subsubsection{Speed}

\paragraph{} An optional third argument is the speed of the turtle relative to 160 cells per minute. The default, 1, corresponds to 160 cells per minute. ``\texttt{2}" would move the turtle at 320 cells per minute. Relative speed was used so it would be easier to tell the speed relation between turtles. This particularly suits phase music. Arbitrary maths can be provided, allowing turtles' speeds to be irrational multiples of each other.

\subsubsection{Number of Loops}

\paragraph{} An optional fourth argument defines the number of repetitions of the turtle's entire path. By default, the turtle loops infinitely. Repeating parts (e.g. the cello  of Pachabel's Canon in D) therefore only need defining once.

\subsection{Highlighting}

\paragraph{} To assist recognising notes and turtles, when the play button is pressed, cells are highlighted. Activated or deactivated turtle definitions are highlighted green. Cells containing definitions of notes, or multiple notes, are highlighted red. Sustain cells are highlighted a lighter red, showing correspondence to notes whilst maintaining differentiation.

\subsection{Chord input}

\paragraph{} To use the musical abstractions of chords whilst keeping the paradigm that a turtle is responsible for up to one note at any time, a tool to add chords is included. The note, type, inversion and starting octave of the chord are inputted in four drop-downs. The insert button enters the notes of the chord into the grid. If a single cell or range taller than it is wide is highlighted in the spreadsheet, the notes are inserted vertically starting at the top-left of the range. Otherwise, the notes will be inserted horizontally. Whether the turtles are moving horizontally or vertically both chords and arpeggios\footnote{Where the notes of a chord are played in rising or descending order} can be easily defined. Thus, helpful musical abstractions are still available whilst keeping the cleanness of the turtle system.

\section{Formative Evaluation}

\paragraph{} To guide development to best suit users, participants were involved in formative evaluation. 21 musical University of Cambridge students, across a range of subjects took place in the participatory design process. Initially, one-on-one tutorials with the initial prototype were given followed by a short exercise. After both of these, users were interviewed on how they found Excello, drawing particular attention to actions that they found particularly unintuitive or requiring notable mental effort. Comparisons were made to musical interfaces that participants were already familiar with. The sessions were audio recorded to prevent jotting down notes causing delays. These were later typed up. The ethical and data handling procedures are discussed in the evaluation chapter.

\paragraph{} To realistically simulate how Excello would be used, participants carried out an exercise of their choice. Often this was transcribing a piece from memory or traditional notation into the Excello notation. Two exercises were provided if participants had no immediate inspiration; transcribing a piece from western notation or changing existing Excello notation.

\paragraph{} These sessions were carried out at in January 2019. Participants were asked to continue using Excello until the summative evaluation sessions in March. Additional feedback was given as participants used Excello in their own time. This also ensured the summative evaluation was done with users with sufficient experience of the interface.
% Participants were encouraged to get in contact with any additional issues or suggestions they had during this time.

\subsection{Issues and Suggestions}

\paragraph{} The issues and suggestions from the participatory design process are summarised below.

\subsubsection{Turtle Notation}

\paragraph{} Dynamics in the turtle instructions made establishing the turtle's path harder as not all commands related movement. As the dynamics weren't next to the notes they corresponded to, knowing the volume of a note or where to place the dynamics within the turtle to apply to notes in the spreadsheet was challenging. The initial prototype had no way to assign a dynamic to notes in the first cell. The starting cell could be empty but this was inconvenient for looping parts as it would be included in the loop. Users not familiar with western notation dynamics found them unintuitive. Furthermore, these discrete markings do not make available a continuous volume scale.

\paragraph{} When transcribing a piece, dividing its tempo by 160 for the relative speed caused unnecessary work. Users also forgot whether relative speed referred to time spent in each cell or how quickly the turtle moved. Following the tutorial, users often had to check the position and meaning of turtle arguments.

\paragraph{} As the number of dynamics and movement commands grew, instructions became long and establishing turtle behaviour became cognitively challenging. Some users confused the ``\texttt{s}" within the turtle instructions to mean sustain (as it does in cells) and not south.

\subsubsection{Feedback}

\paragraph{} It was often unknown if pressing play registered, especially if the workbook saving delayed Excello's access to the spreadsheet. If a turtle had accidentally been left activated, the entire grid required searching to locate it. Users requested a summary of active turtle locations in addition to the highlighting.

\subsubsection{MIDI conversions}

\paragraph{} Users of production software said importing and exporting MIDI files would be helpful. If working with an existing MIDI file, converting that into the Excello notation would be convenient. Exportation would let Excello be used to create chord sequences, bass lines and the piece structure, before adding additional effects and recording in digital audio work stations.

\subsubsection{Sources of effort when writing}

\paragraph{} After inputting notes in the grid, the number of cells the turtle had to move required counting. This is often in a straight line. Whilst the Excel status bar allows users select cells and immediately see how many there are, this is unproductive. This was particularly inconvenient when users were writing notes and periodically testing what they had written so far. Some users instructed turtles to move forward significantly more steps than required to prevent counting. This is not feasible for looping parts. It was suggested that turtles could figure out how far they should move.

\paragraph{} Instructions with repeated movements such as moving to the end of a line and jumping down to the beginning of a line below, required a lot of repetition.

\paragraph{} Many of the notes in melodic lines are in the same octave. As such, repeatedly writing out the octave number was tiresome. One user made a comparison to LilyPond \cite{sandberg:lily} where if the note length is not defined, the previous length would be used.

\paragraph{} Some users find it more intuitive to consider a melodic line by the intervals between notes rather than note names. A modulated\footnote{Where the pitch of every note has moved by the same amount.} melody line required writing out again and could not be derived quicker from the original version.

\subsubsection{Chords}

\paragraph{} Most users used a small subset of the available chord types but had to find these in a large list. Separation of the more common chords was requested. Initially, notes inserted vertically  had the lowest note at the top with pitch increasing down the column. Because higher pitch notes appear higher up the staff, it was suggested that inverting the order would be more intuitive. Initially, it was unclear what the different drop-downs corresponded to, with some users selecting the 7 from the octave number to try and insert a Maj7 chord.

\subsubsection{Activation of turtles}

\paragraph{} When toggling turtles' activations, entering the edit mode for each to add or remove the exclamation mark was very tedious.

\section{Second Prototype}

\paragraph{} Following the formative evaluation sessions and feedback, additions and modifications were made to solve the problems and opportunities that arose.

\subsection{Dynamics}

\paragraph{} To help extract a turtle;s path and establish notes' volumes, dynamics are instead inserted in the cells after the note, separated by a space as in Manhattan \cite{nash:manhattan}. As before, this will persist for all following notes until the volume is redefined. A single turtle definition with multiple start cells can now play parts of different volume. However, notes in the grid can be limited to only playing at their given volume. To play the same notes at a different volume, a new path must be made. Overall, the new system was believed to be preferable.

\paragraph{} To use a continuous volume scale, in addition to existing dynamic symbols, a number between 0 and 1 can instead be provided where 0 is silent and 1 is equivalent to fff.

\subsection{Nested Instructions}

\paragraph{} Nested instructions with repeats reduce turtle instructions and more easily encorporate repeated sections or movements. Multiple commands placed within parentheses followed by a number are repeated that number of times. Whilst the fourth argument of the turtle repeats the turtle's entire musical output, repetitions within the movement instructions allow paths to be defined more concisely.

\subsection{Absolute Tempo}

\paragraph{} The turtle's speed is defined by cells per minute, rather than the initial relative value used initially. However, values less than 10 were interpreted in the original relative way for backwards compatibility with participants' existing work. To maintain consistency in a production version, this will be removed so speed must be defined absolutely. Speed and dynamics will be different orders of magnitude and hence reduce the confusion between them.

\subsection{Custom Excel Functions}

\paragraph{} Two custom Excel functions were implemented to aid composition. One to defines turtles and a second transposes notes.

\subsubsection{Excello.Turtle}

\paragraph{} The existing formulae writing tools provided within Excel are utilised. When writing a formula, a prompt informs users the position of arguments and whether they are optional. This outputs the turtle definition as text. Other cells can be referenced. For example, all turtles could reference a single cell for their speeds. Relative tempi can be implemented by the speed argument of each turtle being a multiple of this global speed as shown in figure \ref{implementation:turtleFunction}.

\begin{figure}[tbh]
\centerline{\includegraphics[width=150mm]{figs/turtleFunction.png}}
\caption{Defining a turtle using the EXCELLO.TURTLE function.}
\label{implementation:turtleFunction}
\end{figure}

\subsubsection{Excello.Modulate}

\paragraph{} A modulating function lets melodic lines be defined by the intervals between notes and provides easy modulation of existing sections of a piece. The function takes a cell and an interval and outputs the cell with any notes transposed by the interval, maintaining any dynamic. A section can be modulated by calling this function on the first note with a provided interval and using the existing drag-fill functionality of Excel. By using the previous note and one of a series of intervals as the arguments, a melodic line can quickly be produced from a starting note and a series of intervals as shown in figure \ref{implementation:modulateFunction}.

\begin{figure}[tbh]
\centerline{\includegraphics[width=150mm]{figs/modulateFunction.png}}
\caption{Transposing notes using the EXCELLO.MODULATE function.}
\label{implementation:modulateFunction}
\end{figure}

%  \ref{examples}

\subsection{Sustain}

\paragraph{} To prevent confusion between the south instruction and sustains. The symbol ``\texttt{-}" sustains a note. This was chosen because it is light and also has some similarity to a tie\footnote{A line to increase the length of a note by joining to another.}. Again, to maintain backwards compatability, ``\texttt{s}" in a cell is still interpreted as a sustain.

\subsection{Active Turtles}

\paragraph{} To show that active turtle definitions have been recognised, a list of locations of the active turtles is given below the play button. This also helps find spurious turtles not intended to be activated.

\subsection{Automatic Movement}

\paragraph{} To prevent counting the cells in a line, \texttt{m*} instructs a turtle to move as far as there are notes or sustains defined in the direction it is facing. After adding more notes, the turtle instructions do not need editing before pressing play. A part may be meant to finish with a number of rests. As rests are notated with blank cells, a method to extend the path to include these rests was required. A cell can be explicitly defined as a rest with ``\texttt{.}". This is required if multiple turtles were playing a repeating section where one does not have its final cell as a note, sustain or multi-note cell. Without an explicit rest, the turtle would repeat too soon and the parts would be out of phase.

\subsection{Inferred Octave}

\paragraph{} Octave numbers are inferred if omitted. Two methods were considered. Firstly, as most intervals within melodic lines are small, the nearest note could be played.
% This means that a scale would only need the octave defining in the first note.
Whilst this may require the fewest explicit statements of octave numbers, it would be hard to find the octave of a given note. The last defined octave in the path would need finding and then all subsequent notes walked through keeping track of the octave. The second consideration was to always use the last defined octave. Whilst this may require many octave definitions around the boundary between octaves, it is easier to find the octave of a note by backtracking. The second option was implemented.

\subsection{Chords}

\paragraph{} To aid entering common chords, common types are repeated in a section at the top of the type drop-down. The chord drop-downs layout was improved with labels to make it clearer what the values refer to. If the notes were entered vertically, the order was reversed, increasing correspondence with traditional staff notation.

\subsection{Activation of turtles}

\paragraph{} A ``Toggle Activation" button was added to the add-in window. When a cell or range is highlighted in the spreadsheet, the activation of any turtle definitions in this range will be toggled when the button is pressed.  This significantly decreases the time to toggle activations as only two clicks are required rather than entering the cell edit mode to add or remove an exclamation mark.

\section{Final Prototype Implementation}

\paragraph{} This section discusses the underlying implementation of the final prototype, following the participatory design. Excello consists of three main parts. The largest is the turtle system for playing the grid contents. The second is the chord input pool. Thirdly, turtle input and modulation is facilitated with custom Excel functions.

\paragraph{} When the play button is pressed, turtle definitions in the grid are identified. For each, the starting cell and movement instructions are used to establish the contents of the cells it passes through. This is converted to a series of note definitions - pitch, start time, duration, volume. The speed and loop parameter are used to create the structure interpreted by the Tone.js library to schedule and initiate playback. An overview of the data flow and subtasks required to create the musical playback is shown in figure \ref{fig:overview}.

\begin{figure}[htb]
\begin{center}
\input{chapters/implementation/overview}
\end{center}
\caption{An overview of the playback algorithm and dataflow of Excello}
\label{fig:overview}
\end{figure}

\paragraph{} The \texttt{Sampler} is an extension of the \texttt{Tone.Instrument} class. This interpolates between pitched samples to create arbitrary notes. A sampler is loaded using the Salamander grand piano samples which includes four pitches (out of a possible 12) per octave. This accurately interpolates notes whilst reducing loading times and storage requirements.

\subsection{Identifying Cells}

\paragraph{} A drop-down is populated with names loaded using the office API. Having pressed play, the cell values from the selected sheet are loaded then analysed for highlighting and calculating the musical output. Cells containing at least one note definition are highlighted red. A note must contain a note name, an optional accidental, optional octave number, and optional volume instruction following a space. This a dynamic marking or number between 0 and 1. Notes are identified using the following regular expression:

\begin{verbatim}
'^[A-G](#|b|)?[1-9]?( (0(\.\[0-9]+)?|1(\.0)?|ppp|pp|p|mp|mf|f|ff|fff))?$'
\end{verbatim}

\paragraph{} Cells containing multiple definitions are split using commas. The resulting strings are trimmed of starting and ending whitespace and then must either be a note, a sustain (``\texttt{-}" or ``\texttt{s}"), explicit rest (``\texttt{.}") or an empty string (created from trimming a rest). Cells matching ``\texttt{-}",``\texttt{.}" or ``\texttt{s}" are highlighted a lighter red. Turtle definitions are identified using:
\begin{verbatim}
'^(!turtle\().*(\))$'
\end{verbatim}
and these cells are highlighted green. The address of cells containing a turtle definition are added to the live turtle section of the add-in window.

\subsection{Parsing Movement Instructions}

\paragraph{} Movement instructions are converted to a single unnested list of commands (e.g. ``\texttt{(r m2)2}" becomes ``\texttt{[r, m2, r, m2]}") so the turtle's path can be established. The \texttt{parse} method of the Parenthesis\footnote{https://www.npmjs.com/package/parenthesis} library seemed suitable for aiding this string manipulation. This parses strings containing brackets into a nested array. For example, \texttt{parse(\textcolor[rgb]{0,0.7,0}{\upquote{a(b[c\{d\}])}})} gives \texttt{[\textcolor[rgb]{0,0.7,0}{\upquote{a(}}, [\textcolor[rgb]{0,0.7,0}{\upquote{b[}}, [\textcolor[rgb]{0,0.7,0}{\upquote{c\{}}, [\textcolor[rgb]{0,0.7,0}{\upquote{d}}], \textcolor[rgb]{0,0.7,0}{\upquote{\}}}], \textcolor[rgb]{0,0.7,0}{\upquote{]}}], \textcolor[rgb]{0,0.7,0}{\upquote{)}}]}.

\paragraph{} This suggests the string ``\texttt{(r m2)2}" would become \texttt{[\upquote{(}, [\upquote{r m2}], \upquote{)2}]}.  By removing the brackets from these strings, a simple recursive method could be built to output \texttt{\upquote{r m2 r m2}} from \texttt{[[\upquote{r m2}], \upquote{2}]}. However, upon testing this, the library outputted an undefined array. From investigating the source code, I established strings with a number following a closing parenthesis all produced this error. Substituting characters for the numbers or placing a symbol before all numbers and then later removing these would allow the library to be used. Instead, using the Parenthesis method as inspiration, I implemented my own parsing function tailored Excello.

\paragraph{} This has two main steps. First, the deepest bracketed expression is stored in an array with the brackets removed. This expression is replaced in the original string with the string \upquote{\texttt{\_\_\_}$x$\texttt{\_\_\_}} where $x$ is the expression's index in the array. This is repeated until the string contains no brackets. Then a recursive function uses the values of $x$ to reconstruct the string in the nested array format. This method is outlined in algorithm \ref{alg:parenthesis}. The Typescript implementation is in Appendix \ref{appendix:parenthesis}.

\begin{algorithm}[!htp]
\caption{Parsing bracketed expression. \texttt{str.replace(regex,f)} (line 13) performs \texttt{f(s)} on the first substring, \texttt{s}, of \texttt{str} matching the regular expression \texttt{regex}.}
\label{alg:parenthesis}
\begin{algorithmic}[1]
\Procedure{parseBrackets}{$str$}

   \State $idPadding\gets \texttt{\upquote{\_\_\_}}$
   \State $unnestedStr\gets []$
   \State $deepestLevelBracketsRE\gets \texttt{RegExp(\upquote{\textbackslash\textbackslash([\^{}\textbackslash\textbackslash(\textbackslash\textbackslash)]*\textbackslash\textbackslash)})}$
   \State $replacementIDRE\gets \texttt{RegExp(\upquote{\textbackslash\textbackslash} + }idPadding\texttt{ + \upquote{([0-9]+)} + }idPadding\texttt{)}$\\

   \Procedure{replaceDeepestBracket}{$x$}
     \State \texttt{unnestedStr.push(x.substring(1, x.length-1))}
     \State \texttt{\textbf{return} idPadding + (unnestedStr.length - 1) + idPadding}
   \EndProcedure \\

   \While{\texttt{deepestLevelBracketsRE.test(str)}}
     \State \texttt{str = str.replace(deepestLevelBracketsRE,replaceDeepestBracket)}
   \EndWhile

   \State \texttt{unnestedStr[0] = str}\\

   \Procedure{reNest}{$outerStr$}
     \State $renestingStr\gets []$
     \While{There is a match of $replacementIDRE$ in $outerStr$}
       \State $matchIndex\gets$ index of the match in $outerStr$
       \State $matchID\gets$ ID of the match (number between padding)
       \State $matchString\gets$ matched string\\

       \If{$matchIndex >$ 0}
				\State $renestingStr$.push($outestStr$.substring(0, $matchIndex$))
			\EndIf
			\State $renestingStr$.push(reNest($unnestedStr$[$firstMatchID$]))
			\State $outestStr$ = $outestStr$.substring($matchIndex$ + $matchString$.length)
     \EndWhile
     \State $renestingStr$.push($outestStr$)
     \State \textbf{return} $renestingStr$
   \EndProcedure \\

   \State \textbf{return} reNest($unnestedStr$[0])

\EndProcedure
\end{algorithmic}
\end{algorithm}


\paragraph{} Having submitted a bug report on the Parenthesis Github, and implemented my own method for parsing turtle movement instructions, I implemented a fix to the Parenthesis library. The library previously performed replacements with the string \upquote{\texttt{\_\_\_}$x$}. $x$ and following numbers would concatenate forming a single number, causing the library to fail. My method of having an identifier before and after $x$ fixed the issue. I also added additional tests to Parenthesis to verify my method and ensure that previous tests all passed before submitting a pull request. This has been merged into the library and published.

\paragraph{} I wrote an additional recursive method to unnest the array into a single stream of commands. An empty string, s, is initialised. For each item in the array, if it is an array, unnest the contents recursively and add the result to s. If not, it will be one or more single movement commands. If the single movement commands start with a number, the result is added to s that number of times. The remaining instructions are added to s. This is outlined in algorithm \ref{alg:unnest}. The implementation is shown in Appendix \ref{appendix:parenthesis}.

\begin{algorithm}[!htbp]
\caption{Unnesting parsed bracketed expressions.}
\label{alg:unnest}
\begin{algorithmic}[1]
\Procedure{processParsedBrackets}{$arr$}

   \State $s\gets \texttt{\upquote{}}$
   \State $previousArr$

   \For{$v$ in $s$}
    \If{$v$ is an array}
     \State $previousArr \gets$ processParsedBrackets($v$)
    \Else
       \If{previous instruction was an array}
        \State $s \gets s + previousArr$
        \If{next instruction is a number}
          \State $s \gets s + previousArr$, that number of times minus one
        \EndIf
       \EndIf
       \State $s \gets s + $ remaining instruction in $v$
    \EndIf
   \EndFor
   \State \textbf{return} $s$

\EndProcedure
\end{algorithmic}
\end{algorithm}

\subsection{Getting Cells in Turtles' paths}

\paragraph{} If the turtle's first argument defines a range of starting cells, the cell addresses of this range are calculated. For each starting cell, the unnested instructions and sheet values are used to find the contents of the cells the turtle passes through. This process models the movement of the turtle within the grid, keeping track of its position and where it is facing. For each instruction, the position and direction are updated as required and the contents of any new cells entered added to a list of notes.

\paragraph{} For the ``\texttt{m*}" instruction, the number of steps the turtle takes must be computed. Given the turtle's current position and direction, the one-dimensional array of cells in front of it is taken. The turtle should step to the last cell that defines a note, sustain or explicit rest. The number of steps is the array's length minus the index of the first element in the reversed array satisfying this criterion.

\subsection{Creating Note Times}

\paragraph{} The cells a turtle moves through are used to create a data structure containing the information for playback using the Tone library. For each turtle, the following array is produced: \texttt{[[<Note 1>,...,<Note N>], <number of cells>]} (note sequence array). Each note is as follows: \texttt{[<start time>, [<pitch>, <duration>, <volume>]]}. Volume and octave are added to each note if they where omitted from a cell.

\paragraph{} The Tone library has many different representations of time. I used Transport Time for all time - onsets and durations. This is in the form \texttt{\upquote{BARS:QUARTERS:SIXTEENTHS}} where the numbers can be non-integer. with \texttt{QUARTERS} representing the number of cells, exact times, or arbitrary musical notes don't need considering.

\paragraph{} The note sequence array is initiated by counting the notes that are defined in the cell contents using regular expressions for identifying notes and multi-note cells. The cells are iterated through keeping track of the active note and adding it to the note sequence when it ends. Outside of this loop, variables track how many cells and notes through the process the algorithm is and whether it is currently a rest or note. Variables keep track of the note currently being played - when it started (\texttt{currentStart}), the pitch (\texttt{currentNote}) and volume (\texttt{currentVolume}). As volume and octave number may be omitted, variables also keep track of these. Table \ref{tab:times} outlines the actions performed when a cell is read. Notes are added to the note sequence in the form \texttt{[currentStart, [currentNote, \upquote{0:} + noteLength + \upquote{:0}, currentVolume]]}.

\begin{table}[ht]
\begin{tabular}{|l|l|lll|}
  \hline
  \textbf{Cell}&\textbf{State}&\multicolumn{3}{c|}{\textbf{Action}} \\
  \hline
  \multirow{5}{*}{Note}&\multirow{3}{*}{Note}&Note, octave and &Previous note added&currentStart = \\
  &&volume established&to note sequence&\upquote{0:}+beatCount+\upquote{:0}\\
  &&from cell contents&&currentNote = value\\
  \cline{2-2}
  \cline{4-4}
  &\multirow{2}{*}{Rest}&and previous values&inRest = false&noteLength = 1\\
  &&&&currentVolume = volume\\
  \hline
  \multirow{2}{*}{Sustain}&Note&\multicolumn{3}{l|}{noteLength++}\\
  \cline{2-5}
  &Rest&\multicolumn{3}{l|}{Nothing (has no semantic value)}\\
  \hline
  \multirow{3}{*}{Rest}&\multirow{2}{*}{Note}&\multicolumn{3}{l|}{Previous note added to note sequence}\\
  &&\multicolumn{3}{l|}{inRest = true}\\
  \cline{2-5}
  &Rest&\multicolumn{3}{l|}{Nothing}\\
  \hline
\end{tabular}
\label{tab:times}
\caption{The actions taken when processing each cell to create note times. The beat count corresponds to the cell number being processed and is incremented each time.}
\end{table}

\paragraph{} The same method is used for multi-note cells, except the note length and cell count are incremented by the appropriate fraction for each item in the cell. If after the final cell, the state is a note, it is ended and added to the note sequence.

\paragraph{} The values in the note sequence are sufficient for the piano sampler to play a note using the \texttt{triggerAttackRelease} function. The \texttt{Tone.Part} class allows multiple calls to this method be defined which can be started, stopped and looped as a single unit. Using the note sequence (``\texttt{noteTimes}"), number of cells (``\texttt{beatsLength}") from creating the note times, number of repeats (``\texttt{repeats}") and the evaluated speed argument (``\texttt{speedFactor}"), playback is scheduled as follows (types have been omitted for brevity):

\begin{verbatim}
var turtlePart = new Tone.Part(function(time, note){
  piano.triggerAttackRelease(note[0], note[1], time, note[2]);
}, noteTimes).start();
if (repeats>0){
  turtlePart = turtlePart.stop("0:" + (repeats*beatsLength/speedFactor) + ":0");
}
turtlePart.loop = true;
turtlePart.loopEnd = "0:" + beatsLength + ":0";
turtlePart.playbackRate = speedFactor;
\end{verbatim}

\subsection{Chord Input}

\paragraph{} When insert is pressed, the note, type, inversion\footnote{which note of the chord is the lowest, the chord ascends from this.} and octave of the chord are extracted from their HTML elements. The tonal library is used to generate the chord notes:

\begin{verbatim}
var chordNotes = Chord.notes(chordNote, chordType).map(x => Note.simplify(x));
\end{verbatim}

\paragraph{} The tonal \texttt{simplify} function reduces note definitions to contain at most one accidental, as required by Excello. This provides a list of notes in ascending order without octaves or taking into account the inversion. To create the correct inversion of the chord, the array of notes is rotated by the inversion number.

\paragraph{} The given octave number is appended to the first note. A dictionary matches note names, accounting for enharmonics\footnote{Notes that are the same pitch but different names, such as Ab and G\#}, to position in the chromatic scale starting at C (the first note of the octave in SPN). For each preceding note, if it appears in an equal or lower position in the scale than its predecessor, the octave number is incremented before appending. Otherwise, it is in the same octave so the octave number is appended without modification.

\paragraph{} The selected range is acquired with the Office API. The chord notes are entered starting at the top-left corner of this range. If the range's height is greater or equal to its width, the notes are entered vertically going down. Otherwise, they are entered horizontally going right. Using the Office API, the range is set to the 2D array where the chord is entered.

\subsection{Custom Excel Functions}

\paragraph{} Custom functions are implemented using another add-in. Rather than a separate window like the main Excello add-in, additional functions can be used in cells with the prefix ``=EXCELLO.". The file structure was generated with the Yeomann generator. The name, description, result type, and parameter names and types are stored in a JSON schema. This is used by Excel to provide argument prompts and autofill when writing formulae. Functions are defined in Typescript.

\paragraph{} The turtle function concatenates the arguments into the Excello turtle format. Other cells can be referenced, for example, the speed variable can reference a global tempo variable as in figure \ref{implementation:turtleFunction}.

\paragraph{} The modulation function separates the note and volume for every note defined in a cell. The note is modulated using the tonal \texttt{Distance.transpose} function and recombined with the volume. The drag fill feature of Excel can be employed by the user to transpose sections or define melodic lines using the interval between notes as in figure \ref{implementation:modulateFunction}.

\section{MIDI Converter}

\paragraph{} This section explains the Python converter from MIDI to CSV for Excello playback. A MIDI file is divided into up to 16 parallel tracks \cite{midiSpec}. Each track contains a series of messages defined using predefined status and data bytes. I used the Mido library\footnote{https://mido.readthedocs.io/en/latest/index.html} to read MIDI files and abstract away from the underlying byte representations to view the messages. Note onsets and offsets are two separate events with two separate messages \cite{midiSpec}. These messages include the note pitch, velocity, channel (not relevant) and time in ticks since the last message \cite{midoSpec}.

\paragraph{} First, the list of messages is converted to a list of notes defined by onset and offset time, pitch and velocity. For each track, the messages are iterated through, using the time value in every message (including control and meta messages) to update a variable tracking time. For note onset messages, this is added to a dictionary mapping pitches to a list of currently active note start times. Lists are used because a pitch can be active multiple times at once. For note offset messages, or onset messages with zero velocity, the note popped from the active notes at that pitch with end time added is added to the list of all notes defined in the file.

\paragraph{} As each turtle only plays one note at a time, the notes are split into lists so no list contains concurrently played notes. Provided the initial list of notes is non-empty, a new list is created. The first remaining note is moved to the new list. Then iterating over the remaining notes, the next note starting after the previous note ends is moved to this new list. The number of iterations required is the number of turtles, $n$.

\paragraph{} If every tick corresponds to a cell, any combination of note onsets and offsets in a MIDI file can be accurately represented in Excello. To achieve smaller representations, the start and end times are converted to smaller cell numbers within the path of the turtle. For many MIDI files, the duration of a note is different from the time it occupies in notation. For example, a note immediately followed by another note in notation may have an end time significantly less than the start time of the next note in MIDI. A method is required to account for this. For all notes, before creating the different turtle streams, the length of the notes in ticks and differences between consecutive start times are found. The minimum value greater than 1 or modal value for these times are calculated depending on the compression level giving the $lengthStat$ and $differenceStat$.
\vspace{-10pt}

  $$ratio_{int} = \lfloor\max(lengthStat, differenceStat)/\min(lengthStat, differenceStat)\rfloor$$
  % $$ratio_{int} = \lfloor ratio \rfloor$$
  % $$correction = ratio/ratio_{int}$$
For each note, the times are adjusted as follows:
  $$length \gets (start - end) / lengthStat \text{ (rounded to the nearest 0.1)}$$
  $$start \gets start / differenceStat \times ratio_{int} \text{ (rounded to the nearest 0.1)}$$
  $$end \gets start +length$$

\paragraph{} The streams, with note start and end times corresponding to cells, are converted to a CSV file for Excello. Each turtle's path is initialised as an array of empty strings with length equal to the maximum end time for a note in any turtle, $L$.  Each note the turtle plays is entered into the array. MIDI defines pitch using the integers. As there are 12 notes in an octave, modulus and division with 12 gives the note name and octave for SPN. If velocity is different to the previous note played by the turtle (or the note is the first note), the eight-bit MIDI velocity is mapped to Excello's [0,1] range. If the note length is greater than one, sustains are placed in the following cells. These paths go right starting in column A, with the first in row 2.

\paragraph{} Finally, the turtle definition is placed in the spreadsheet. The start cell range is ``A2:A$(n+1)$". The movement instruction is ``r m$L$". The MIDI file contains meta data for the \texttt{tempo} (milliseconds per beat) and \texttt{ticks\_per\_beat}. Cells per minute is calculated as follows:
  $$cells\ per\ tick \times ticks\ per\ beat \times beat\ per\ minute$$
  $$= \frac{ratio_{int}}{mode\ difference} \times \texttt{ticks\_per\_beat} \times \frac{60 \times 10^6}{\texttt{tempo}}$$
With one for repeats, the turtle definition is put in cell A1 and the CSV exported.

\input{chapters/implementation/repo}
